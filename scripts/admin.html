<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Access Manager</title>
  <link rel="stylesheet" href="../assets/styles.css">
  <script>
    window.__FIREBASE_CONFIG = window.__FIREBASE_CONFIG || {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_APP.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
    };
  </script>
</head>
<body>
  <main class="layout" style="max-width: 960px; margin: 2rem auto;">
    <section class="details-panel" style="grid-column: 1 / -1;">
      <h1>Access Requests</h1>
      <p class="placeholder">This page is restricted to admins. Sign in on the main site before opening it.</p>
      <div id="status" class="alert alert-info">Checking authentication…</div>

      <section id="admin-panel" hidden>
        <form id="allowlist-form" class="rsvp-form" aria-label="Add email to allowlist">
          <label>
            Email
            <input type="email" id="allowlist-email" name="email" placeholder="coach@example.com" required autocomplete="off">
          </label>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;align-items:flex-end;">
            <button type="submit" class="button">Approve access</button>
            <button type="button" id="clear-selection" class="button button-secondary">Clear</button>
          </div>
        </form>

        <div id="requests-container" class="status-group" style="margin-top: 1.5rem;">
          <h2>Pending requests</h2>
          <ul id="request-list" class="request-list" style="display:grid;gap:0.75rem;padding:0;list-style:none;"></ul>
        </div>

        <section id="access-code-manager" class="card access-manager" hidden>
          <div>
            <h2>Access code manager</h2>
            <p class="access-manager__status" id="access-code-status">Loading access gate…</p>
            <p class="access-manager__meta" id="access-code-meta" aria-live="polite"></p>
          </div>

          <div class="access-manager__section">
            <h3>Active code</h3>
            <div class="access-manager__code" id="active-code-value" aria-live="polite">••••••••</div>
            <div class="access-manager__actions">
              <button type="button" class="button button-secondary" id="reveal-active-code">Reveal</button>
              <button type="button" class="button button-secondary" id="copy-active-code" hidden>Copy</button>
              <button type="button" class="button button-secondary" id="hide-active-code" hidden>Hide</button>
              <button type="button" class="button button-danger" id="expire-code">Expire active code</button>
            </div>
          </div>

          <div class="access-manager__section">
            <h3>Rotate access code</h3>
            <div class="access-manager__generated" id="generated-code">Generate a new code</div>
            <div class="access-manager__actions">
              <button type="button" class="button" id="generate-code">Generate code</button>
              <button type="button" class="button button-secondary" id="copy-generated-code" hidden>Copy</button>
              <button type="button" class="button filled" id="activate-generated-code" disabled>Activate code</button>
            </div>
          </div>
        </section>
      </section>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="assertive" hidden></div>

  <script type="module" src="../src/firebase.js"></script>
  <script type="module" src="../src/auth.js"></script>
  <script type="module" src="../src/dataModel.js"></script>
  <script type="module" src="../src/ui.js"></script>
  <script type="module">
    import {
      doc,
      getDoc,
      onSnapshot,
      serverTimestamp,
      setDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    const statusEl = document.getElementById('status');
    const adminPanel = document.getElementById('admin-panel');
    const requestList = document.getElementById('request-list');
    const allowlistForm = document.getElementById('allowlist-form');
    const emailInput = document.getElementById('allowlist-email');
    const clearSelectionButton = document.getElementById('clear-selection');
    const accessManager = document.getElementById('access-code-manager');
    const gateStatusEl = document.getElementById('access-code-status');
    const gateMetaEl = document.getElementById('access-code-meta');
    const activeCodeValue = document.getElementById('active-code-value');
    const revealActiveButton = document.getElementById('reveal-active-code');
    const copyActiveButton = document.getElementById('copy-active-code');
    const hideActiveButton = document.getElementById('hide-active-code');
    const expireButton = document.getElementById('expire-code');
    const generateButton = document.getElementById('generate-code');
    const generatedCodeEl = document.getElementById('generated-code');
    const copyGeneratedButton = document.getElementById('copy-generated-code');
    const activateGeneratedButton = document.getElementById('activate-generated-code');

    const { db } = window.App.firebase || {};
    const accessGateDocRef = db ? doc(db, 'config', 'access_gate') : null;
    const accessSecretDocRef = db ? doc(db, 'config', 'access_gate_secret') : null;

    if (gateMetaEl) {
      gateMetaEl.hidden = true;
    }

    let unsubscribeRequests = null;
    let unsubscribeGate = null;
    let activeCodeSecret = null;
    let gateSnapshot = { status: 'loading', updatedAt: null, expiresAt: null, updatedBy: null, hash: null };
    let generatedCode = '';
    let currentUser = null;
    let activeCodeRevealed = false;

    function setStatus(message, tone = 'info') {
      statusEl.textContent = message;
      statusEl.className = tone === 'error' ? 'alert' : 'alert alert-info';
    }

    function clearSelection() {
      emailInput.value = '';
      allowlistForm.removeAttribute('data-request-id');
      allowlistForm.removeAttribute('data-request-name');
    }

    function formatDate(date) {
      if (!date) {
        return 'Unknown date';
      }
      return new Intl.DateTimeFormat(undefined, {
        dateStyle: 'medium',
        timeStyle: 'short',
      }).format(date);
    }

    function formatDateTime(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
        return null;
      }
      return new Intl.DateTimeFormat(undefined, {
        dateStyle: 'medium',
        timeStyle: 'short',
      }).format(date);
    }

    function formatGateStatus(snapshot) {
      switch (snapshot.status) {
        case 'active':
          return 'Access code is active. Share with trusted coaches only.';
        case 'expired':
          return 'The previous access code has expired. Generate a new code to restore access.';
        case 'inactive':
          return 'No active access code. Generate and activate a new code when ready.';
        case 'error':
          return 'Unable to load the access gate right now. Check your connection.';
        default:
          return 'Loading access gate…';
      }
    }

    function hideActiveCode() {
      if (!activeCodeValue) return;
      activeCodeRevealed = false;
      activeCodeValue.textContent = '••••••••';
      if (revealActiveButton) {
        revealActiveButton.hidden = false;
        revealActiveButton.disabled = false;
      }
      if (copyActiveButton) {
        copyActiveButton.hidden = true;
        copyActiveButton.disabled = true;
      }
      if (hideActiveButton) {
        hideActiveButton.hidden = true;
        hideActiveButton.disabled = true;
      }
    }

    function showActiveCode(code) {
      if (!activeCodeValue) return;
      activeCodeRevealed = true;
      activeCodeValue.textContent = code;
      if (revealActiveButton) {
        revealActiveButton.hidden = true;
      }
      if (copyActiveButton) {
        copyActiveButton.hidden = false;
        copyActiveButton.disabled = false;
      }
      if (hideActiveButton) {
        hideActiveButton.hidden = false;
        hideActiveButton.disabled = false;
      }
    }

    function updateAccessManagerUI() {
      if (!accessManager || !gateStatusEl || !gateMetaEl) return;
      gateStatusEl.textContent = formatGateStatus(gateSnapshot);

      const metaBits = [];
      const updatedAt = formatDateTime(gateSnapshot.updatedAt);
      if (updatedAt) {
        if (gateSnapshot.updatedBy) {
          metaBits.push(`Updated ${updatedAt} by ${gateSnapshot.updatedBy}`);
        } else {
          metaBits.push(`Updated ${updatedAt}`);
        }
      }
      const expiresAt = formatDateTime(gateSnapshot.expiresAt);
      if (expiresAt && gateSnapshot.status === 'active') {
        metaBits.push(`Expires ${expiresAt}`);
      }
      gateMetaEl.textContent = metaBits.join(' • ');
      gateMetaEl.hidden = metaBits.length === 0;

      const isActive = gateSnapshot.status === 'active' && Boolean(gateSnapshot.hash);
      if (!isActive) {
        hideActiveCode();
      }
      if (revealActiveButton) {
        revealActiveButton.disabled = !isActive;
      }
      if (expireButton) {
        expireButton.disabled = !isActive;
      }
    }

    function renderGeneratedCode() {
      if (!generatedCodeEl || !copyGeneratedButton || !activateGeneratedButton) return;
      if (generatedCode) {
        generatedCodeEl.textContent = generatedCode;
        copyGeneratedButton.hidden = false;
        copyGeneratedButton.disabled = false;
        activateGeneratedButton.disabled = false;
      } else {
        generatedCodeEl.textContent = 'Generate a new code';
        copyGeneratedButton.hidden = true;
        copyGeneratedButton.disabled = true;
        activateGeneratedButton.disabled = true;
      }
    }

    function generateRandomCode(length = 10) {
      const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      const randomValues = new Uint32Array(length);
      window.crypto.getRandomValues(randomValues);
      return Array.from(randomValues, (value) => alphabet[value % alphabet.length]).join('');
    }

    async function sha256Hex(value) {
      const encoder = new TextEncoder();
      const data = encoder.encode(value);
      const digest = await window.crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(digest))
        .map((byte) => byte.toString(16).padStart(2, '0'))
        .join('');
    }

    async function copyToClipboard(text) {
      if (!text) {
        throw new Error('Nothing to copy');
      }
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      }
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.setAttribute('readonly', '');
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      const result = document.execCommand('copy');
      document.body.removeChild(textarea);
      if (!result) {
        throw new Error('Clipboard unavailable');
      }
      return true;
    }

    function subscribeToAccessGate() {
      if (!accessGateDocRef) {
        gateSnapshot = { status: 'error', hash: null, updatedAt: null, expiresAt: null, updatedBy: null };
        updateAccessManagerUI();
        return;
      }
      if (typeof unsubscribeGate === 'function') {
        unsubscribeGate();
      }
      unsubscribeGate = onSnapshot(
        accessGateDocRef,
        (snapshot) => {
          const data = snapshot.exists() ? snapshot.data() : {};
          const rawHash = typeof data.hash === 'string' ? data.hash.trim() : '';
          let status = data.status || (rawHash ? 'active' : 'inactive');
          let expiresAt = data.expiresAt?.toDate?.() ?? null;
          if (expiresAt && expiresAt instanceof Date && expiresAt.getTime() <= Date.now()) {
            status = 'expired';
          }
          const previousHash = gateSnapshot.hash;
          const hash = status === 'active' && rawHash ? rawHash : null;
          gateSnapshot = {
            status,
            hash,
            updatedAt: data.updatedAt?.toDate?.() ?? null,
            expiresAt: expiresAt && status === 'active' ? expiresAt : null,
            updatedBy: data.updatedByEmail || data.updatedBy || null,
          };
          if (status !== 'active' || (hash && hash !== previousHash)) {
            activeCodeSecret = null;
            hideActiveCode();
          }
          updateAccessManagerUI();
        },
        (error) => {
          console.error('Access gate listener error', error);
          gateSnapshot = { status: 'error', hash: null, updatedAt: null, expiresAt: null, updatedBy: null };
          updateAccessManagerUI();
        }
      );
    }

    async function revealActiveCode() {
      if (!accessSecretDocRef) {
        window.App.ui.showToast('Firestore not initialised.', { tone: 'error' });
        return;
      }
      if (revealActiveButton) {
        revealActiveButton.disabled = true;
      }
      try {
        if (!activeCodeSecret || gateSnapshot.status !== 'active') {
          const snapshot = await getDoc(accessSecretDocRef);
          activeCodeSecret = snapshot.exists() ? snapshot.data() : null;
        }
        const code = activeCodeSecret?.code;
        if (!code) {
          window.App.ui.showToast('No active code to reveal.', { tone: 'info' });
          hideActiveCode();
          return;
        }
        showActiveCode(code);
      } catch (error) {
        console.error(error);
        window.App.ui.showToast(error.message || 'Unable to load access code.', { tone: 'error' });
      } finally {
        if (revealActiveButton) {
          revealActiveButton.disabled = false;
        }
      }
    }

    async function handleCopyActive() {
      const code = activeCodeSecret?.code;
      if (!code) {
        window.App.ui.showToast('Reveal the active code before copying.', { tone: 'info' });
        return;
      }
      try {
        await copyToClipboard(code);
        window.App.ui.showToast('Access code copied.', { tone: 'success' });
      } catch (error) {
        console.error(error);
        window.App.ui.showToast(error.message || 'Unable to copy.', { tone: 'error' });
      }
    }

    function generateNewCode() {
      generatedCode = generateRandomCode(10);
      renderGeneratedCode();
    }

    async function handleCopyGenerated() {
      if (!generatedCode) {
        window.App.ui.showToast('Generate a code before copying it.', { tone: 'info' });
        return;
      }
      try {
        await copyToClipboard(generatedCode);
        window.App.ui.showToast('Generated code copied.', { tone: 'success' });
      } catch (error) {
        console.error(error);
        window.App.ui.showToast(error.message || 'Unable to copy code.', { tone: 'error' });
      }
    }

    async function rotateGeneratedCode() {
      if (!generatedCode) {
        window.App.ui.showToast('Generate a code first.', { tone: 'info' });
        return;
      }
      if (!accessGateDocRef || !accessSecretDocRef) {
        window.App.ui.showToast('Firestore not initialised.', { tone: 'error' });
        return;
      }
      activateGeneratedButton.disabled = true;
      activateGeneratedButton.textContent = 'Activating…';
      try {
        const hash = await sha256Hex(generatedCode);
        const timestamp = serverTimestamp();
        await Promise.all([
          setDoc(
            accessGateDocRef,
            {
              hash,
              status: 'active',
              updatedAt: timestamp,
              updatedBy: currentUser?.uid || null,
              updatedByEmail: currentUser?.email || null,
              expiresAt: null,
            },
            { merge: true }
          ),
          setDoc(
            accessSecretDocRef,
            {
              code: generatedCode,
              hash,
              status: 'active',
              updatedAt: timestamp,
              updatedBy: currentUser?.uid || null,
              updatedByEmail: currentUser?.email || null,
            },
            { merge: true }
          ),
        ]);
        gateSnapshot = {
          status: 'active',
          hash,
          updatedAt: new Date(),
          expiresAt: null,
          updatedBy: currentUser?.email || currentUser?.uid || null,
        };
        activeCodeSecret = { code: generatedCode };
        showActiveCode(generatedCode);
        generatedCode = '';
        renderGeneratedCode();
        updateAccessManagerUI();
        window.App.ui.showToast('Access code rotated.', { tone: 'success' });
      } catch (error) {
        console.error(error);
        window.App.ui.showToast(error.message || 'Failed to activate code.', { tone: 'error' });
      } finally {
        activateGeneratedButton.disabled = false;
        activateGeneratedButton.textContent = 'Activate code';
      }
    }

    async function expireActiveCode() {
      if (!accessGateDocRef || !accessSecretDocRef) {
        window.App.ui.showToast('Firestore not initialised.', { tone: 'error' });
        return;
      }
      const confirmed = window.confirm('Expire the current access code? Coaches will need a new code to sign in.');
      if (!confirmed) {
        return;
      }
      expireButton.disabled = true;
      expireButton.textContent = 'Expiring…';
      try {
        const timestamp = serverTimestamp();
        await Promise.all([
          setDoc(
            accessGateDocRef,
            {
              status: 'expired',
              hash: '',
              updatedAt: timestamp,
              expiresAt: timestamp,
              updatedBy: currentUser?.uid || null,
              updatedByEmail: currentUser?.email || null,
            },
            { merge: true }
          ),
          setDoc(
            accessSecretDocRef,
            {
              status: 'expired',
              code: '',
              hash: '',
              updatedAt: timestamp,
              expiredAt: timestamp,
              updatedBy: currentUser?.uid || null,
              updatedByEmail: currentUser?.email || null,
            },
            { merge: true }
          ),
        ]);
        gateSnapshot = {
          status: 'expired',
          hash: null,
          updatedAt: new Date(),
          expiresAt: new Date(),
          updatedBy: currentUser?.email || currentUser?.uid || null,
        };
        activeCodeSecret = null;
        hideActiveCode();
        updateAccessManagerUI();
        window.App.ui.showToast('Access code expired.', { tone: 'success' });
      } catch (error) {
        console.error(error);
        window.App.ui.showToast(error.message || 'Failed to expire the access code.', { tone: 'error' });
      } finally {
        expireButton.disabled = false;
        expireButton.textContent = 'Expire active code';
      }
    }

    function teardownAccessManager() {
      if (!accessManager) return;
      if (typeof unsubscribeGate === 'function') {
        unsubscribeGate();
        unsubscribeGate = null;
      }
      accessManager.hidden = true;
      gateSnapshot = { status: 'loading', hash: null, updatedAt: null, expiresAt: null, updatedBy: null };
      if (gateStatusEl) {
        gateStatusEl.textContent = 'Loading access gate…';
      }
      if (gateMetaEl) {
        gateMetaEl.textContent = '';
        gateMetaEl.hidden = true;
      }
      activeCodeSecret = null;
      generatedCode = '';
      hideActiveCode();
      renderGeneratedCode();
    }

    function initAccessManager(user) {
      if (!accessManager) return;
      currentUser = user;
      accessManager.hidden = false;
      subscribeToAccessGate();
      updateAccessManagerUI();
      renderGeneratedCode();
    }

    function renderRequests(requests) {
      requestList.innerHTML = '';

      if (!requests.length) {
        const empty = document.createElement('li');
        empty.className = 'placeholder';
        empty.textContent = 'No pending requests.';
        requestList.appendChild(empty);
        return;
      }

      requests.forEach((request) => {
        const item = document.createElement('li');
        item.className = 'card';
        item.style.padding = '1rem';
        item.style.display = 'grid';
        item.style.gap = '0.5rem';

        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'baseline';

        const email = document.createElement('strong');
        email.textContent = request.email || request.id;

        const date = document.createElement('span');
        date.className = 'auth-note';
        date.textContent = formatDate(request.requestedAt);

        header.append(email, date);

        const name = document.createElement('div');
        name.textContent = request.name || request.displayName || 'Unknown requester';

        const approveButton = document.createElement('button');
        approveButton.type = 'button';
        approveButton.className = 'button button-secondary';
        approveButton.textContent = 'Select for approval';
        approveButton.addEventListener('click', () => {
          emailInput.value = request.email || '';
          allowlistForm.dataset.requestId = request.id;
          if (request.name || request.displayName) {
            allowlistForm.dataset.requestName = request.name || request.displayName;
          } else {
            allowlistForm.removeAttribute('data-request-name');
          }
          emailInput.focus();
        });

        item.append(header, name, approveButton);
        requestList.appendChild(item);
      });
    }

    async function handleSubmission(event) {
      event.preventDefault();
      const email = emailInput.value.trim();
      if (!email) {
        window.App.ui.showToast('Enter an email before approving.', { tone: 'error' });
        return;
      }

      const submitButton = allowlistForm.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = 'Saving…';

      try {
        const metadata = {};
        const matchingRequest = allowlistForm.dataset.requestId
          ? { id: allowlistForm.dataset.requestId }
          : null;
        if (matchingRequest?.id) {
          metadata.requestId = matchingRequest.id;
        }
        if (allowlistForm.dataset.requestName) {
          metadata.requestedBy = allowlistForm.dataset.requestName;
        }
        await window.App.dataModel.addEmailToAllowlist(email, metadata);
        if (matchingRequest?.id) {
          await window.App.dataModel.deleteAccessRequest(matchingRequest.id);
        }
        window.App.ui.showToast('Access granted.', { tone: 'success' });
        clearSelection();
      } catch (error) {
        console.error(error);
        window.App.ui.showToast(error.message || 'Failed to approve access.', { tone: 'error' });
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Approve access';
      }
    }

    allowlistForm.addEventListener('submit', handleSubmission);
    clearSelectionButton.addEventListener('click', () => {
      clearSelection();
      emailInput.focus();
    });

    hideActiveCode();
    renderGeneratedCode();

    if (revealActiveButton) {
      revealActiveButton.addEventListener('click', revealActiveCode);
    }
    if (hideActiveButton) {
      hideActiveButton.addEventListener('click', () => hideActiveCode());
    }
    if (copyActiveButton) {
      copyActiveButton.addEventListener('click', handleCopyActive);
    }
    if (generateButton) {
      generateButton.addEventListener('click', generateNewCode);
    }
    if (copyGeneratedButton) {
      copyGeneratedButton.addEventListener('click', handleCopyGenerated);
    }
    if (activateGeneratedButton) {
      activateGeneratedButton.addEventListener('click', rotateGeneratedCode);
    }
    if (expireButton) {
      expireButton.addEventListener('click', expireActiveCode);
    }

    window.App.auth.listenToAuth(async (user) => {
      currentUser = user || null;
      if (!user) {
        setStatus('Please sign in on the main site before opening this page.');
        adminPanel.hidden = true;
        if (typeof unsubscribeRequests === 'function') {
          unsubscribeRequests();
          unsubscribeRequests = null;
        }
        teardownAccessManager();
        return;
      }

      const isAdmin = await window.App.dataModel.checkIfAdmin(user.uid);
      if (!isAdmin) {
        setStatus('Only admins can manage access requests.');
        adminPanel.hidden = true;
        if (typeof unsubscribeRequests === 'function') {
          unsubscribeRequests();
          unsubscribeRequests = null;
        }
        teardownAccessManager();
        return;
      }

      setStatus(`Signed in as ${user.displayName || user.email}. Pending requests appear below.`);
      adminPanel.hidden = false;
      initAccessManager(user);

      if (typeof unsubscribeRequests === 'function') {
        unsubscribeRequests();
      }
      unsubscribeRequests = window.App.dataModel.listenToAccessRequests(renderRequests);
    });
  </script>
</body>
</html>
