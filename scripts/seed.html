<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Seed Training Events</title>
  <link rel="stylesheet" href="../assets/styles.css">
  <script>
    window.__FIREBASE_CONFIG = window.__FIREBASE_CONFIG || {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_APP.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
    };
  </script>
</head>
<body>
  <main class="layout" style="max-width: 960px; margin: 2rem auto;">
    <section class="details-panel" style="grid-column: 1 / -1;">
      <h1>Seed Training Events</h1>
      <p class="placeholder">This helper page is for admins only. Sign in on the main app before using it.</p>
      <div id="status" class="alert alert-info">Checking authenticationâ€¦</div>
      <form id="event-form" class="rsvp-form" hidden>
        <label>
          Title <span class="required" aria-hidden="true">*</span>
          <input type="text" name="title" required>
        </label>
        <label>
          Start (local time) <span class="required" aria-hidden="true">*</span>
          <input type="datetime-local" name="start" required>
        </label>
        <label>
          End (local time)
          <input type="datetime-local" name="end">
        </label>
        <label>
          Location
          <input type="text" name="location">
        </label>
        <label>
          Notes
          <textarea name="notes" rows="3"></textarea>
        </label>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
          <button type="submit" class="button">Create event</button>
          <button type="button" id="seed-examples" class="button button-secondary">Add sample set</button>
        </div>
      </form>
    </section>
  </main>

  <script type="module" src="../src/firebase.js"></script>
  <script type="module" src="../src/auth.js"></script>
  <script type="module" src="../src/dataModel.js"></script>
  <script type="module">
    const statusEl = document.getElementById('status');
    const form = document.getElementById('event-form');
    const seedButton = document.getElementById('seed-examples');

    function setStatus(message, tone = 'info') {
      statusEl.textContent = message;
      statusEl.className = tone === 'error' ? 'alert' : 'alert alert-info';
    }

    window.App.auth.listenToAuth(async (user) => {
      if (!user) {
        setStatus('Please sign in on the main site before opening this page.');
        form.hidden = true;
        return;
      }
      const isAdmin = await window.App.dataModel.checkIfAdmin(user.uid);
      if (!isAdmin) {
        setStatus('Only admins can seed events. Ask an admin to grant access.');
        form.hidden = true;
        return;
      }
      setStatus(`Signed in as ${user.displayName || user.email}. You can create events below.`);
      form.hidden = false;
      form.dataset.uid = user.uid;
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const data = new FormData(form);
      const title = data.get('title')?.toString().trim();
      if (!title) {
        setStatus('Title is required.', 'error');
        return;
      }
      const startValue = data.get('start');
      const endValue = data.get('end');
      const payload = {
        title,
        start: startValue ? new Date(startValue) : null,
        end: endValue ? new Date(endValue) : null,
        location: data.get('location')?.toString(),
        notes: data.get('notes')?.toString(),
        createdBy: form.dataset.uid,
      };
      try {
        await window.App.dataModel.createEvent(payload);
        setStatus('Event created successfully.', 'info');
        form.reset();
      } catch (error) {
        console.error(error);
        setStatus('Failed to create event. Check console for details.', 'error');
      }
    });

    seedButton.addEventListener('click', async () => {
      if (!form.dataset.uid) {
        setStatus('Sign in as an admin first.', 'error');
        return;
      }
      const baseDate = new Date();
      const sessions = [
        {
          title: 'U8 Skills Training',
          start: shiftDays(baseDate, 2, 17),
          end: shiftDays(baseDate, 2, 18),
          location: 'Community Field A',
          notes: 'Bring pinnies and water bottles.',
        },
        {
          title: 'Speed & Agility Clinic',
          start: shiftDays(baseDate, 5, 18),
          end: shiftDays(baseDate, 5, 19),
          location: 'Indoor Center Court 2',
        },
        {
          title: 'Weekend Scrimmage',
          start: shiftDays(baseDate, 7, 10),
          end: shiftDays(baseDate, 7, 12),
          location: 'Main Pitch',
          notes: 'Arrive 15 minutes early for warm-up.',
        },
      ];

      try {
        await Promise.all(
          sessions.map((session) =>
            window.App.dataModel.createEvent({ ...session, createdBy: form.dataset.uid })
          )
        );
        setStatus('Sample events added.', 'info');
      } catch (error) {
        console.error(error);
        setStatus('Failed to add sample events.', 'error');
      }
    });

    function shiftDays(base, daysAhead, hour) {
      const copy = new Date(base);
      copy.setDate(base.getDate() + daysAhead);
      copy.setHours(hour, 0, 0, 0);
      return copy;
    }
  </script>
</body>
</html>
